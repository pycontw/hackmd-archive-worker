---
titles: 隨買即用系統 (購票流程自動化)
tags: 2022-registration,registration
---
[TOC]
# 隨買即用系統 (購票流程自動化)
## 情境
因為過去活動都是在活動開始前將資料從 KKTIX 匯入到我們的系統(Gather town)，導致必須要提早結束販賣並處理匯入流程，但近期線上舉辦，線上活動更有可能販賣晚鳥票等現場活動，讓臨時參與的人能想加入根參加就能加入，若能將其流程自動化便能可以到活動開始都能繼續賣票

## 構思
購票之後流程自動化，買票以後->直接匯入 gather town 系統 -> 使用者購票後就能直接登入 gather town

~~~mermaid
flowchart LR
    kktix-webhook --> kktix-pycontw
	Scheduler --> kktix-pycontw
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
    kktix-pycontw --> Authorizer(Gather Town, Youtube)
	kktix-pycontw --> BigQuery
    Authorizer --> Mailer
    Mailer --> Client
~~~
### kktix-webhook/Scheduler( Discord ):
原先構想是在 KKTIX 那接一個 hook，每有人購票成功就把購票資訊帶過來，但是 KKTIX 目前沒有什麼相關功能。因此目前最土炮構想是每兩到五分鐘戳一次 kktix 來比較有什麼新購買的票，並將其 Email 資訊推送給 Autbhorizer，也要請使用者購票後五分鐘再嘗試登入

### Discord 指令
#### 功能
~~~mermaid
flowchart LR
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
~~~

```
@bot event list //顯示所有在賣活動
@bot event status [活動 slug] // 顯示活動的售票狀況 
活動 slug :2022-reserved
活動: PyCon APAC 2022 Registration: Reserved【Online Conference】
活動狀態: "開賣中"/"已結束"
票種:
- Submitter投稿者票（with Pyckage）: 總數:10 已售: 10
- Speaker 講者票（with Pyckage） : 總數:10 已售: 2
- Invited 預留票: 總數:不限 已售: 2

@bot event [活動slug] [時間區間(2022/03/05~2022/04/02)]
下載連結: [google 表單]


```
csv example:
|         | 2022/03/05 | 2022/03/06 | 2022/03/07 | 總售票數  |
|---------|-----------:|------------|------------|---------|
| ticket1 |          0 | 0          | 0          |    0    |
| ticket2 |          0 | 0          | 1          |    1    |
| ticket3 |          1 | 0          | 2          |    2    |


### 溝通API文件
https://docs.google.com/document/d/1OOtG_2SagCR7ZJRquVJZCNpGXPgHTH9Hc0D2Uj6b4gw/edit

### kktix-pycontw:
將從 KKTIX 撈到的資料經過處理存在自家的系統上，個人敏感資料部分要做權限上的控管
- KKTIX-api 機制
- 篩選資料
- 去識別化功能
#### 技術採用:
語言使用: python 3.9+
使用 lib: 
使用 flask 當作 web framework (cloud funtion 的 python 僅支援此 lib)
cli:
想透過 cloud function 跟 api gateway 的免費額度去 cover 所使用的費用
實做成 cmdline tool 並使用 deploy 在 cloud function 上，並透過 API Gateway 提供 Route

### Authorizer:
拿到 Trigger 帶來的 E-mail 地址將其加入 gather town 白名單，目前詢問過場務組 GATHER TOWN 權限是由 Vivian 統一開啟，可能要研究一下 gather town 這裡的 API 做處理

### Mailer:
同樣做成 cloudrun 的形式，並透過 API gateway 去執行?
寄信系統，應該跟行前信系統相同，將拿到的 gather town 網址來組成行前信並且將信件寄出

### Client:
參與者，會眾

## PHASE 1
以達到 discord 機器人能正常行為為目標
~~~mermaid
flowchart LR
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
~~~

## PHASE 2
Mail Handler 可完整寄信
~~~mermaid
flowchart LR
	Mailer --> Client
~~~

## PHASE 3
Discord 串接接通 Authorizer

~~~mermaid
flowchart LR
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
    kktix-pycontw --> Authorizer
~~~

## PHASE 4
將 Discord 串接到 Mail handler 成功發信
~~~mermaid
flowchart LR
   
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
    kktix-pycontw --> Authorizer
    Authorizer --> Mailer
    Mailer --> Client
~~~

## PHASE FINAL
將所有的功能實做完成
~~~mermaid
flowchart LR
	kktix-pycontw --> BigQuery
    kktix-webhook --> kktix-pycontw
	Scheduler --> kktix-pycontw
	Discord_CMD --> kktix-pycontw
	kktix-pycontw --> Discord_channel
    kktix-pycontw --> Authorizer
    Authorizer --> Mailer
    Mailer --> Client
~~~

## REF
- [Serverless Discord Custom Slash Commands bot with AWS API Gateway and Lambda](https://oozio.medium.com/serverless-discord-bot-55f95f26f743)
- [Cloud Functions Pricing](https://cloud.google.com/functions/pricing)
- [GCP API Gateway pricing](https://cloud.google.com/api-gateway/pricing)
- [HTTP Functions](https://cloud.google.com/functions/docs/writing/http)

